@page "/laboratorios"
@using FISEI.ServiceDesk.Web.Services
@inject NavigationManager Nav
@inject FISEI.ServiceDesk.Web.Services.AuthClientService Auth
@inject LaboratoriosService LabSvc
<RoleNav />

<main class="main-content">
  <section class="content-card">
    <div class="page-header">
      <div>
        <h2 class="page-title"><i class="fas fa-building"></i> Laboratorios</h2>
        <p class="page-subtitle">Administra los laboratorios de la facultad</p>
      </div>
      <div class="header-actions">
        <div class="filter-group">
          <label class="filter-label">
            <i class="fas fa-filter"></i> Filtrar:
          </label>
          <select class="form-control filter-select" @onchange="OnActivoFilterChanged">
            <option value="all" selected="@(activoFiltro is null)">Todos</option>
            <option value="true" selected="@(activoFiltro == true)">Activos</option>
            <option value="false" selected="@(activoFiltro == false)">Inactivos</option>
          </select>
        </div>
        <button class="btn btn-primary btn-new" @onclick="()=>nuevoVisible=true">
          <i class="fas fa-plus"></i> Nuevo laboratorio
        </button>
      </div>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
      <div class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i> @error
      </div>
    }

    @if (loading)
    {
      <div class="loading-container">
        <div class="spinner"></div>
        <p class="muted">Cargando laboratorios...</p>
      </div>
    }
    else if (laboratorios.Count == 0)
    {
      <div class="empty-state">
        <i class="fas fa-inbox"></i>
        <h3>No hay laboratorios</h3>
        <p>Comienza agregando el primer laboratorio</p>
        <button class="btn btn-primary" @onclick="()=>nuevoVisible=true">
          <i class="fas fa-plus"></i> Crear laboratorio
        </button>
      </div>
    }
    else
    {
      <div class="table-container">
        <table class="table-modern">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nombre</th>
              <th>Edificio</th>
              <th>Ubicación</th>
              <th>Estado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @foreach (var l in laboratorios)
            {
              <tr>
                <td><span class="badge badge-code">@l.Codigo</span></td>
                <td class="fw-medium">@l.Nombre</td>
                <td>@l.Edificio</td>
                <td>@l.Ubicacion</td>
                <td>
                  @if (l.Activo)
                  {
                    <span class="badge badge-success">
                      <i class="fas fa-check-circle"></i> Activo
                    </span>
                  }
                  else
                  {
                    <span class="badge badge-inactive">
                      <i class="fas fa-times-circle"></i> Inactivo
                    </span>
                  }
                </td>
                <td class="text-end">
                  <div class="action-buttons">
                    <button class="btn-icon btn-edit" @onclick="()=>Editar(l)" title="Editar">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-delete" @onclick="()=>ConfirmarEliminar(l.Id)" title="Eliminar">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    @if(nuevoVisible)
    {
      <div class="modal-overlay" @onclick="CerrarNuevo">
        <div class="modal" @onclick:stopPropagation="true">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-plus-circle"></i> Nuevo laboratorio
            </h5>
            <button class="btn-close" @onclick="CerrarNuevo" title="Cerrar">×</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label"><i class="fas fa-barcode"></i> Código</label>
              <input class="form-control" @bind="nuevo.Codigo" placeholder="Ej: LAB-01" />
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-tag"></i> Nombre</label>
              <input class="form-control" @bind="nuevo.Nombre" placeholder="Ej: Laboratorio de Redes" />
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-building"></i> Edificio</label>
              <input class="form-control" @bind="nuevo.Edificio" placeholder="Ej: Edificio A" />
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-map-marker-alt"></i> Ubicación</label>
              <input class="form-control" @bind="nuevo.Ubicacion" placeholder="Ej: Piso 2, Ala Este" />
            </div>
            <div class="form-group">
              <div class="custom-checkbox">
                <input id="chkNuevoActivo" type="checkbox" @bind="nuevo.Activo" />
                <label for="chkNuevoActivo"><i class="fas fa-check-circle"></i> Laboratorio activo</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" disabled="@saving" @onclick="Crear">
              <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn btn-secondary" @onclick="CerrarNuevo">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </div>
      </div>
    }

    @if(editId.HasValue)
    {
      <div class="modal-overlay" @onclick="CancelarEdicion">
        <div class="modal" @onclick:stopPropagation="true">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit"></i> Editar laboratorio
            </h5>
            <button class="btn-close" @onclick="CancelarEdicion" title="Cerrar">×</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label"><i class="fas fa-barcode"></i> Código</label>
              <input class="form-control" @bind="editModel!.Codigo" />
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-tag"></i> Nombre</label>
              <input class="form-control" @bind="editModel!.Nombre" />
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-building"></i> Edificio</label>
              <input class="form-control" @bind="editModel!.Edificio" />
            </div>
            <div class="form-group">
              <label class="form-label"><i class="fas fa-map-marker-alt"></i> Ubicación</label>
              <input class="form-control" @bind="editModel!.Ubicacion" />
            </div>
            <div class="form-group">
              <div class="custom-checkbox">
                <input id="chkEditActivo" type="checkbox" @bind="editModel!.Activo" />
                <label for="chkEditActivo"><i class="fas fa-check-circle"></i> Laboratorio activo</label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" disabled="@saving" @onclick="GuardarEdicion">
              <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn btn-secondary" @onclick="CancelarEdicion">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </div>
      </div>
    }

    @* Modal de confirmación de borrado *@
    @if (mostrarConfirmacion)
    {
      <div class="modal-overlay" @onclick="CancelarEliminar">
        <div class="modal modal-confirm" @onclick:stopPropagation="true">
          <div class="modal-header modal-header-danger">
            <h5 class="modal-title">
              <i class="fas fa-exclamation-triangle"></i> Confirmación de eliminación
            </h5>
            <button class="btn-close" @onclick="CancelarEliminar" title="Cerrar">×</button>
          </div>
          <div class="modal-body">
            <div class="confirm-message">
              <i class="fas fa-trash-alt confirm-icon"></i>
              <p class="confirm-text">¿Estás seguro que deseas eliminar este laboratorio?</p>
              <p class="confirm-warning">Esta acción no se puede deshacer.</p>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-danger" @onclick="EliminarConfirmado">
              <i class="fas fa-trash-alt"></i> Sí, eliminar
            </button>
            <button class="btn btn-secondary" @onclick="CancelarEliminar">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </div>
      </div>
    }
  </section>
</main>

@code {
  private bool loading;
  private bool saving;
  private string? error;

  private bool? activoFiltro = null;
  private List<LaboratorioDto> laboratorios = new();

  private bool nuevoVisible;
  private LaboratorioEditDto nuevo = new();

  private int? editId;
  private LaboratorioEditDto? editModel;

  private bool mostrarConfirmacion = false;
  private int? deleteId = null;

  protected override async Task OnInitializedAsync()
  {
    if (!Auth.IsAuthenticated) { Nav.NavigateTo("/login", true); return; }
    await CargarLista();
  }

  private async Task CargarLista()
  {
    loading = true; error = null;
    try { laboratorios = await LabSvc.ListarAsync(activoFiltro); }
    catch (Exception ex) { error = ex.Message; }
    finally { loading = false; }
  }

  private async Task Crear()
  {
    saving = true; error = null;
    try {
      await LabSvc.CrearAsync(nuevo);
      nuevo = new(); nuevoVisible = false;
      await CargarLista();
    } catch (Exception ex) { error = ex.Message; }
    finally { saving = false; }
  }

  private void CerrarNuevo() { nuevo = new(); nuevoVisible = false; }

  private void Editar(LaboratorioDto l)
  {
    editId = l.Id;
    editModel = new LaboratorioEditDto {
      Codigo = l.Codigo,
      Nombre = l.Nombre,
      Edificio = l.Edificio,
      Ubicacion = l.Ubicacion,
      Activo = l.Activo
    };
  }

  private async Task GuardarEdicion()
  {
    if (!editId.HasValue || editModel is null) return;
    saving = true; error = null;
    try {
      await LabSvc.ActualizarAsync(editId.Value, editModel);
      editId = null; editModel = null;
      await CargarLista();
    } catch (Exception ex) { error = ex.Message; }
    finally { saving = false; }
  }

  private void CancelarEdicion() { editId = null; editModel = null; }

  private void ConfirmarEliminar(int id)
  {
    deleteId = id;
    mostrarConfirmacion = true;
  }

  private async Task EliminarConfirmado()
  {
    if (deleteId is int id)
    {
      saving = true; error = null;
      try {
        await LabSvc.EliminarAsync(id);
        await CargarLista();
      } catch (Exception ex) { error = ex.Message; }
      finally { saving = false; }
    }
    mostrarConfirmacion = false;
    deleteId = null;
  }

  private void CancelarEliminar()
  {
    mostrarConfirmacion = false;
    deleteId = null;
  }

  private async Task OnActivoFilterChanged(ChangeEventArgs e)
  {
    var val = e.Value?.ToString();
    activoFiltro = val switch {
      "true" => true,
      "false" => false,
      _ => null
    };
    await CargarLista();
  }
}

<style>
  /* Page Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .page-title {
    font-size: 1.75rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .page-subtitle {
    color: #6c757d;
    margin: 0.25rem 0 0 0;
    font-size: 0.95rem;
  }
  .header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }
  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .filter-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #495057;
    white-space: nowrap;
  }
  .filter-select {
    padding: 0.5rem 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 0.9rem;
  }
  
  /* Buttons */
  .btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }
  .btn-primary {
    background: linear-gradient(135deg, #8B0000 0%, #5c0000 100%);
    color: white;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 0, 0, 0.4);
  }
  .btn-success {
    background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
    color: white;
  }
  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4);
  }
  .btn-danger {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
  }
  .btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
  }
  .btn-secondary {
    background: #6c757d;
    color: white;
  }
  .btn-secondary:hover {
    background: #5a6268;
  }
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }

  /* Table */
  .table-container {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .table-modern {
    width: 100%;
    border-collapse: collapse;
  }
  .table-modern thead {
    background: linear-gradient(135deg, #8B0000 0%, #5c0000 100%);
    color: white;
  }
  .table-modern th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
  }
  .table-modern td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
  }
  .table-modern tbody tr {
    transition: background-color 0.2s;
  }
  .table-modern tbody tr:hover {
    background-color: #f8f9fa;
  }
  .text-end { text-align: right; }
  .fw-medium { font-weight: 500; }

  /* Badges */
  .badge {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }
  .badge-code {
    background: #e9ecef;
    color: #495057;
    font-family: 'Courier New', monospace;
  }
  .badge-success {
    background: #d4edda;
    color: #155724;
  }
  .badge-inactive {
    background: #f8d7da;
    color: #721c24;
  }

  /* Action Buttons */
  .action-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
  }
  .btn-icon {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn-edit {
    background: #fee2e2;
    color: #8B0000;
  }
  .btn-edit:hover {
    background: #8B0000;
    color: white;
    transform: scale(1.1);
  }
  .btn-delete {
    background: #fef2f2;
    color: #dc2626;
  }
  .btn-delete:hover {
    background: #dc2626;
    color: white;
    transform: scale(1.1);
  }

  /* Loading */
  .loading-container {
    text-align: center;
    padding: 3rem;
  }
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #8B0000;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  @@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }
  .empty-state i {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 1rem;
  }
  .empty-state h3 {
    color: #495057;
    margin-bottom: 0.5rem;
  }
  .empty-state p {
    color: #6c757d;
    margin-bottom: 1.5rem;
  }

  /* Alert */
  .alert {
    padding: 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  .alert-error {
    background: #f8d7da;
    color: #721c24;
    border-left: 4px solid #c62828;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1050;
    animation: fadeIn 0.2s;
  }
  @@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .modal {
    background: #fff;
    width: 600px;
    max-width: 90vw;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s;
  }
  @@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .modal-confirm {
    width: 480px;
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
    background: linear-gradient(135deg, #8B0000 0%, #5c0000 100%);
    border-radius: 12px 12px 0 0;
  }
  .modal-header-danger {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  }
  .modal-title {
    color: white;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .modal-body {
    padding: 1.5rem;
  }
  .modal-footer {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
  }
  .btn-close {
    background: transparent;
    border: none;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    color: white;
    opacity: 0.8;
    transition: opacity 0.2s;
  }
  .btn-close:hover {
    opacity: 1;
  }

  /* Form */
  .form-group {
    margin-bottom: 1.5rem;
  }
  .form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .form-control {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  .form-control:focus {
    outline: none;
    border-color: #8B0000;
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
  }
  .custom-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
  }
  .custom-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  .custom-checkbox label {
    margin: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #495057;
  }

  /* Confirm Modal */
  .confirm-message {
    text-align: center;
    padding: 1rem;
  }
  .confirm-icon {
    font-size: 3.5rem;
    color: #dc2626;
    margin-bottom: 1rem;
  }
  .confirm-text {
    font-size: 1.1rem;
    color: #495057;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }
  .confirm-warning {
    color: #6c757d;
    font-size: 0.9rem;
    margin: 0;
  }
</style>