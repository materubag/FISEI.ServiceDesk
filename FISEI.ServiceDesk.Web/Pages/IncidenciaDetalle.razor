@page "/incidencia/{id:int}"
@using FISEI.ServiceDesk.Web.Services
@inject NavigationManager Nav
@inject AuthClientService Auth
@inject IncidenciasService IncSvc
@inject ServiciosService ServSvc
@inject PrioridadesService PriSvc
@inject EstadosService EstSvc

@code {
    [Parameter] public int id { get; set; }
    private bool loading = true;
    private string? error;
    private IncidenciaDetalleDto? inc;
    private string nuevoComentario = "";
    private bool esInterno = false;

    private string? servicioNombre;
    private string? prioridadNombre;
    private string? estadoTexto;

    protected override async Task OnInitializedAsync()
    {
        if (!Auth.IsAuthenticated) { Nav.NavigateTo("/login", true); return; }
        await Cargar();
    }

    private async Task Cargar()
    {
        loading = true; error = null;
        try
        {
            inc = await IncSvc.ObtenerDetalleAsync(id);
            if (inc is not null)
            {
                // Servicio
                servicioNombre = !string.IsNullOrWhiteSpace(inc.ServicioNombre)
                    ? inc.ServicioNombre
                    : (await ServSvc.ObtenerAsync(inc.ServicioId))?.Nombre ?? $"#{inc.ServicioId}";

                // Prioridad
                prioridadNombre = !string.IsNullOrWhiteSpace(inc.PrioridadNombre)
                    ? inc.PrioridadNombre
                    : (await PriSvc.ObtenerAsync(inc.PrioridadId))?.Nombre ?? $"#{inc.PrioridadId}";

                // Estado con fallback a Codigo
                if (!string.IsNullOrWhiteSpace(inc.EstadoNombre))
                {
                    estadoTexto = inc.EstadoNombre;
                }
                else
                {
                    var estado = await EstSvc.ObtenerAsync(inc.EstadoId);
                    estadoTexto = !string.IsNullOrWhiteSpace(estado?.Nombre)
                        ? estado!.Nombre!
                        : (!string.IsNullOrWhiteSpace(estado?.Codigo) ? estado!.Codigo! : $"#{inc.EstadoId}");
                }
            }
        }
        catch (Exception ex) { error = ex.Message; }
        finally { loading = false; }
    }

    private async Task EnviarComentario()
    {
        try {
            await IncSvc.AgregarComentarioAsync(id, new ComentarioCrearDto { Texto = nuevoComentario, EsInterno = esInterno });
            nuevoComentario = ""; await Cargar();
        } catch (Exception ex) { error = ex.Message; }
    }
}

<header class="institutional-header">
  <div class="header-container">
    <div class="logo-container"><div class="uta-logo"><i class="fas fa-ticket-alt"></i></div><div class="university-info"><h1>Incidencia #@id</h1></div></div>
  </div>
</header>

<main class="main-content">
  @if (loading) { <p class="muted">Cargando...</p> }
  else if (!string.IsNullOrEmpty(error)) { <div class="alert-error">@error</div> }
  else if (inc is null) { <p class="muted">No encontrada</p> }
  else
  {
    <section class="content-card">
      <h2>@inc.Titulo</h2>
      <p class="muted">@inc.Descripcion</p>
      <p>
        <b>Servicio:</b> @servicioNombre —
        <b>Prioridad:</b> @prioridadNombre —
        <b>Estado:</b> @estadoTexto
      </p>
    </section>

    <section class="content-card">
      <div class="card-header"><h3><i class="fas fa-comments"></i> Comentarios</h3></div>
      @if (inc.Comentarios?.Count > 0)
      {
        <ul>
          @foreach (var c in inc.Comentarios)
          {
            <li><b>@c.AutorNombre</b> (@c.Fecha.ToLocalTime()) — @(c.EsInterno ? "[Interno]" : "")<br />@c.Texto</li>
          }
        </ul>
      }
      else { <p class="muted">Sin comentarios</p> }

      <div class="form-stack" style="margin-top:8px">
        <textarea class="form-control" rows="3" @bind="nuevoComentario" placeholder="Agregar comentario..."></textarea>
        <label class="form-label"><input type="checkbox" @bind="esInterno" /> Interno (visible técnicos)</label>
        <button class="btn btn-primary" @onclick="EnviarComentario"><i class="fas fa-plus"></i> Enviar</button>
      </div>
    </section>
  }
</main>