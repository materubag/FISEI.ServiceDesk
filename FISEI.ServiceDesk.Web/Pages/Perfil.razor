@page "/perfil"
@inject NavigationManager Nav
@inject FISEI.ServiceDesk.Web.Services.AuthClientService Auth
@inject FISEI.ServiceDesk.Web.Services.UsuariosService Users

@code {
    private bool loading = true;
    private string? error;
    private UsuarioPerfilDto perfil = new();
    private CambiarPasswordDto pass = new();
    private string? okMsg;

    protected override async Task OnInitializedAsync()
    {
        if (!Auth.IsAuthenticated) { Nav.NavigateTo("/login", true); return; }
        pass.UsuarioId = Auth.CurrentUserId!.Value;
        await Cargar();
    }

    private async Task Cargar()
    {
        loading = true; error = okMsg = null;
        try { perfil = await Users.ObtenerPerfilAsync(Auth.CurrentUserId!.Value) ?? new(); }
        catch (Exception ex) { error = ex.Message; }
        finally { loading = false; }
    }

    private async Task GuardarPerfil()
    {
        error = okMsg = null;
        try { await Users.ActualizarPerfilAsync(perfil); okMsg = "Perfil actualizado."; }
        catch (Exception ex) { error = ex.Message; }
    }

    private async Task CambiarPassword()
    {
        error = okMsg = null;
        try {
            await Users.CambiarPasswordAsync(pass);
            okMsg = "Contraseña actualizada.";
            pass = new CambiarPasswordDto { UsuarioId = Auth.CurrentUserId!.Value };
        } catch (Exception ex) { error = ex.Message; }
    }
}

<header class="institutional-header">
  <div class="header-container">
    <div class="logo-container">
      <div class="uta-logo"><i class="fas fa-user-cog"></i></div>
      <div class="university-info"><h1>Mi Perfil</h1><p>@Auth.CurrentUserRole</p></div>
    </div>
    <NotificacionesBadge />
  </div>
  </header>

<main class="main-content">
  @if (loading) { <p class="muted">Cargando...</p> }
  else
  {
    @if (!string.IsNullOrEmpty(error)) { <div class="alert-error">@error</div> }
    @if (!string.IsNullOrEmpty(okMsg)) { <div class="content-card" style="border-left:4px solid #16a34a">@okMsg</div> }

    <section class="content-card">
      <div class="card-header"><h2><i class="fas fa-id-card"></i> Datos de perfil</h2></div>
      <div class="form-stack">
        <label class="form-label">Nombre
          <input class="form-control" @bind="perfil.Nombre" />
        </label>
        <label class="form-label">Correo (institucional)
          <input class="form-control" @bind="perfil.Correo" />
        </label>
        <div class="form-actions">
          <button class="btn btn-primary" @onclick="GuardarPerfil"><i class="fas fa-save"></i> Guardar</button>
        </div>
      </div>
    </section>

    <section class="content-card">
      <div class="card-header"><h2><i class="fas fa-key"></i> Cambiar contraseña</h2></div>
      <div class="form-stack">
        <label class="form-label">Contraseña actual
          <input class="form-control" type="password" @bind="pass.PasswordActual" />
        </label>
        <label class="form-label">Nueva contraseña
          <input class="form-control" type="password" @bind="pass.PasswordNueva" />
        </label>
        <label class="form-label">Confirmar nueva contraseña
          <input class="form-control" type="password" @bind="pass.PasswordNuevaConfirmacion" />
        </label>
        <div class="form-actions">
          <button class="btn btn-primary" @onclick="CambiarPassword"><i class="fas fa-exchange-alt"></i> Actualizar</button>
        </div>
      </div>
    </section>
  }
</main>
