@page "/"
@using FISEI.ServiceDesk.Web.Services
@inject NavigationManager Nav
@inject FISEI.ServiceDesk.Web.Services.AuthClientService Auth
@inject FISEI.ServiceDesk.Web.Services.IncidenciasService IncSvc

@code {
    private bool loading = true;
    private string? error;
    private DashboardVmDto vm = new();
    private bool redirectToLogin;

    protected override async Task OnInitializedAsync()
    {
      // Evitar navegar durante la inicialización para no lanzar NavigationException.
      if (!Auth.IsAuthenticated)
      {
        redirectToLogin = true;
        return;
      }
      try { vm = await IncSvc.GetDashboardAsync(Auth.CurrentUserId!.Value); }
      catch (Exception ex) { error = ex.Message; }
      finally { loading = false; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
      if (firstRender && redirectToLogin)
      {
        try
        {
          Nav.NavigateTo("/login", false);
        }
        catch (Microsoft.AspNetCore.Components.NavigationException)
        {
          // Ignorar la excepción de navegación; la redirección es intencional.
        }
      }
      await Task.CompletedTask;
    }

    private void LogoutAndNavigate()
    {
        Auth.Logout();
      try
      {
        Nav.NavigateTo("/login", true);
      }
      catch (Microsoft.AspNetCore.Components.NavigationException)
      {
        // Ignore navigation exception; navigation will proceed.
      }
    }
}



<nav class="main-navigation">
  <div class="nav-container">
    <ul class="nav-menu">
      <li><a class="active" href="/"><i class="fas fa-tachometer-alt"></i> Inicio</a></li>
      <li><a href="/incidencias"><i class="fas fa-list-alt"></i> Incidencias</a></li>
      <li><a href="/servicios"><i class="fas fa-cogs"></i> Servicios</a></li>
      <li><a href="/kb"><i class="fas fa-book"></i> Base de Conocimiento</a></li>
      <li><a href="/laboratorios"><i class="fas fa-building"></i> Laboratorios</a></li>
    </ul>
  </div>
</nav>

<main class="main-content">
  <section class="dashboard-overview">
    <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Panel de Control - FIESI</h2>

    @if (loading) { <p class="muted">Cargando...</p> }
    else if (!string.IsNullOrEmpty(error)) { <div class="alert-error">@error</div> }
    else
    {
      <div class="stats-grid">
        <div class="stat-card stat-primary"><div class="stat-icon"><i class="fas fa-ticket-alt"></i></div><div class="stat-content"><h3>Activos</h3><span class="stat-number">@vm.Activos</span></div></div>
        <div class="stat-card stat-warning"><div class="stat-icon"><i class="fas fa-clock"></i></div><div class="stat-content"><h3>En Progreso</h3><span class="stat-number">@vm.EnProgreso</span></div></div>
        <div class="stat-card stat-success"><div class="stat-icon"><i class="fas fa-check-circle"></i></div><div class="stat-content"><h3>Resueltos (mes)</h3><span class="stat-number">@vm.ResueltosMes</span></div></div>
        <div class="stat-card stat-danger"><div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="stat-content"><h3>Críticos</h3><span class="stat-number">@vm.Criticos</span></div></div>
      </div>

      <section class="content-card">
        <div class="card-header">
          <h2><i class="fas fa-list-alt"></i> Recientes</h2>
          <a class="btn" href="/incidencias"><i class="fas fa-arrow-right"></i> Ver todo</a>
        </div>
        <div class="table-container">
          <table class="data-table">
            <thead><tr><th>ID</th><th>Fecha</th><th>Servicio</th><th>Título</th><th>Prioridad</th><th>Estado</th></tr></thead>
            <tbody>
              @foreach (var t in vm.Recientes)
              {
                <tr>
                  <td><a href=@($"/incidencia/{t.Id}")>@t.Id</a></td>
                  <td>@t.FechaCreacion.ToLocalTime()</td>
                  <td>@t.ServicioNombre</td>
                  <td>@t.Titulo</td>
                  <td>@t.PrioridadNombre</td>
                  <td>@t.EstadoNombre</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </section>
    }
  </section>
</main>