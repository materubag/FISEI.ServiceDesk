@page "/incidencia/nueva"
@using FISEI.ServiceDesk.Web.Services
@inject NavigationManager Nav
@inject FISEI.ServiceDesk.Web.Services.AuthClientService Auth
@inject FISEI.ServiceDesk.Web.Services.IncidenciasService IncSvc
@inject FISEI.ServiceDesk.Web.Services.ServiciosService ServSvc

@code {
    private bool saving;
    private string? error;
    private NuevaIncidenciaDto model = new();
    private List<ServicioDto> servicios = new();

    protected override async Task OnInitializedAsync()
    {
        if (!Auth.IsAuthenticated) { Nav.NavigateTo("/login", false); return; }
      servicios = await ServSvc.ListarAsync();
      model.CreadorId = Auth.CurrentUserId!.Value;
      if (servicios.Count > 0)
      {
        model.ServicioId = servicios[0].Id;
      }
      if (model.PrioridadId == 0)
      {
        model.PrioridadId = 2; // Media por defecto
      }
    }

    private async Task Guardar()
    {
        error = null; saving = true;
        try {
            var id = await IncSvc.CrearAsync(model);
            Nav.NavigateTo($"/incidencia/{id}", false);
        } catch (Exception ex) { error = ex.Message; }
        finally { saving = false; }
    }
}

<header class="institutional-header">
  <div class="header-container">
    <div class="logo-container"><div class="uta-logo"><i class="fas fa-plus"></i></div><div class="university-info"><h1>Nueva Incidencia</h1></div></div>
  </div>
</header>

<main class="main-content">
  <section class="content-card">
    @if (!string.IsNullOrEmpty(error)) { <div class="alert-error">@error</div> }
    <div class="form-stack">
      <label class="form-label">Servicio
        <select class="form-control" @bind="model.ServicioId">
          @foreach (var s in servicios) { <option value="@s.Id">@s.Nombre</option> }
        </select>
      </label>
      <label class="form-label">Título
        <input class="form-control" @bind="model.Titulo" />
      </label>
      <label class="form-label">Descripción
        <textarea class="form-control" rows="5" @bind="model.Descripcion"></textarea>
      </label>
      <label class="form-label">Prioridad
        <select class="form-control" @bind="model.PrioridadId">
          <option value="1">Baja</option><option value="2">Media</option><option value="3">Alta</option><option value="4">Crítica</option>
        </select>
      </label>
      <label class="form-label">Laboratorio (opcional)
        <input class="form-control" type="number" @bind="model.LaboratorioId" />
      </label>
      <div class="form-actions">
        <button class="btn btn-primary" disabled="@saving" @onclick="Guardar"><i class="fas fa-paper-plane"></i> Registrar</button>
        <a class="btn" href="/incidencias">Cancelar</a>
      </div>
    </div>
  </section>
</main>
